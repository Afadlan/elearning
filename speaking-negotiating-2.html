<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>IELTS Speaking - Negotiating Practice</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    rel="stylesheet"
  />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: "Roboto", sans-serif;
      perspective: 1000px;
      background-color: #f0f7ff;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    /* 3D Card container */
    .card {
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      will-change: transform;
      transform-style: preserve-3d;
      border-radius: 1rem;
      cursor: grab;
      background: white;
      box-shadow: 0 8px 15px rgba(59, 130, 246, 0.1);
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      padding: 1.5rem;
    }
    .card:active {
      cursor: grabbing;
    }
    .card:hover {
      box-shadow: 0 20px 40px rgba(59, 130, 246, 0.3);
    }
    /* Button 3D style */
    .btn-animate {
      position: relative;
      overflow: hidden;
      transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
      z-index: 10;
      border-radius: 0.375rem;
      box-shadow: 0 6px 0 #1e40af;
      transform-style: preserve-3d;
      transform-origin: center bottom;
      background-color: #3b82f6;
      color: white;
      font-weight: 600;
      padding: 0.75rem 1.25rem;
      font-size: 0.875rem;
      user-select: none;
      cursor: pointer;
    }
    .btn-animate::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 300%;
      height: 300%;
      background: rgba(59, 130, 246, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%) scale(0);
      transition: transform 0.5s ease;
      z-index: 0;
    }
    .btn-animate:hover::before {
      transform: translate(-50%, -50%) scale(1);
    }
    .btn-animate:hover {
      background-color: #2563eb;
      box-shadow: 0 12px 0 #1e40af;
      transform: translateY(-4px) rotateX(10deg);
      color: white;
      z-index: 11;
    }
    .btn-animate:active {
      box-shadow: 0 3px 0 #1e40af;
      transform: translateY(-1px) rotateX(5deg);
    }
    /* Speaking interface styling */
    .speaking-interface {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin: 1rem 0;
      text-align: center;
    }
    .microphone-button {
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 50%;
      width: 4rem;
      height: 4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.5rem;
      margin: 0 auto 1rem;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }
    .microphone-button:hover {
      background: #b91c1c;
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
    }
    .microphone-button.recording {
      background: #ef4444;
      animation: pulse 1.5s infinite;
    }
    .microphone-button.processing {
      background: #f59e0b;
      animation: spin 1s linear infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .recording-status {
      font-size: 0.875rem;
      color: #64748b;
      margin-bottom: 1rem;
    }
    .transcript-display {
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      padding: 1rem;
      margin: 1rem 0;
      min-height: 3rem;
      text-align: left;
      font-size: 0.875rem;
      color: #374151;
    }
    .feedback-section {
      background: #f0f9ff;
      border: 1px solid #0ea5e9;
      border-radius: 0.5rem;
      padding: 1rem;
      margin: 1rem 0;
      text-align: left;
    }
    .score-display {
      display: flex;
      justify-content: space-around;
      margin: 1rem 0;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .score-item {
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      padding: 0.75rem;
      text-align: center;
      flex: 1;
      min-width: 120px;
    }
    .score-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: #059669;
    }
    .score-label {
      font-size: 0.75rem;
      color: #64748b;
      margin-top: 0.25rem;
    }
    /* Logo behind text container */
    header {
      position: relative;
      z-index: 10;
      padding: 1.5rem 1.5rem 1.5rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      max-width: 90rem;
      margin: 0 auto;
    }
    header .bg-logo {
      position: absolute;
      top: 0;
      right: 0;
      width: 200px;
      height: 200px;
      object-fit: contain;
      border-radius: 9999px;
      opacity: 0.15;
      z-index: 0;
      pointer-events: none;
    }
    @media (max-width: 768px) {
      header .bg-logo {
        width: 120px;
        height: 120px;
        opacity: 0.1;
      }
    }
    @media (max-width: 480px) {
      header .bg-logo {
        width: 80px;
        height: 80px;
        opacity: 0.08;
      }
    }
    .font-golden {
      font-weight: 700;
      color: #2563eb;
      font-size: 1.125rem;
      user-select: none;
    }
    /* Scrollbar hidden for main content */
    main::-webkit-scrollbar {
      display: none;
    }
    main {
      -ms-overflow-style: none;
      scrollbar-width: none;
      position: relative;
      padding-bottom: 5rem;
    }
    /* Inner card for conversation text */
    .inner-card {
      border: 1px solid #334155;
      border-radius: 0.5rem;
      padding: 1rem;
      font-size: 0.75rem;
      color: #1e293b;
      line-height: 1.3;
      margin-bottom: 1.5rem;
      background: white;
      user-select: text;
    }
    .inner-card p {
      margin-bottom: 0.5rem;
    }
    .inner-card p strong {
      font-weight: 700;
    }
    /* Progress bar styling */
    progress {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 0.25rem;
      border-radius: 9999px;
      overflow: hidden;
      margin-top: 0.25rem;
      margin-bottom: 0.5rem;
    }
    progress::-webkit-progress-bar {
      background-color: #cbd5e1;
    }
    progress::-webkit-progress-value {
      background-color: #2563eb;
      transition: width 1s linear;
    }
    progress::-moz-progress-bar {
      background-color: #2563eb;
      transition: width 1s linear;
    }
    /* Fixed next button bottom right */
    .next-button-container {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      z-index: 20;
    }
    @media (max-width: 640px) {
      .next-button-container {
        position: static;
        margin-top: 1rem;
        display: flex;
        justify-content: flex-end;
        padding-right: 1.5rem;
      }
      main {
        padding-bottom: 1rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <img
      alt="ReallyEnglish logo with letters R and E in blue square"
      class="relative z-10"
      height="40"
      src="https://storage.googleapis.com/a1aa/image/d09cce8d-911a-405c-e6b3-63ef1c89ae3a.jpg"
      width="40"
      decoding="async"
      loading="lazy"
    />
    <span class="font-golden select-none">ReallyEnglish</span>
    <img
      alt="Large blue gradient circle shape behind header text"
      class="bg-logo"
      height="200"
      src="https://storage.googleapis.com/a1aa/image/7a536139-0f90-464f-5576-28fa91748278.jpg"
      width="200"
      decoding="async"
      loading="lazy"
    />
  </header>
  <main class="max-w-4xl mx-auto px-6 py-8 flex-grow">
    <section class="mb-6">
      <div
        class="bg-[#2563eb] text-white text-[10px] text-center py-1 rounded-md select-none font-semibold"
        aria-label="IELTS Speaking test title"
      >
        IELTS Speaking Practice - Negotiating Skills (B1 Level)
      </div>
      <progress
        id="progressBar"
        max="100"
        value="30"
        aria-label="Speaking test progress bar"
        role="progressbar"
        aria-valuemin="0"
        aria-valuemax="100"
        aria-valuenow="30"
      ></progress>
      <p
        class="text-[10px] text-center text-black/80 select-none leading-tight"
        aria-live="polite"
        aria-atomic="true"
        id="countdownText"
      >
        Questions 3-4 of 10<br />
        <span id="timeDisplay">Negotiating Practice</span>
      </p>
    </section>
    <section
      class="card rounded-xl"
      aria-label="Speaking Assessment - Negotiating section"
      id="mainCard"
    >
      <div class="inner-card" aria-live="polite" aria-atomic="true">
        <p class="font-bold text-center mb-1">
          IELTS Speaking - Negotiating Skills (B1)
        </p>
        <p class="text-center mb-3">
          Continue practicing your negotiation skills. Read the passages aloud with clear pronunciation and natural intonation.
        </p>
        <p class="font-bold mb-3">Part 2: Workplace Negotiations</p>
        
        <div class="speaking-interface">
          <p class="text-sm font-semibold mb-2">🎤 Speaking Task 3 - Read Aloud</p>
          <p class="text-sm mb-4"><strong>Instructions:</strong> Read the following workplace negotiation passage aloud. Focus on professional tone and clear articulation.</p>
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-left">
            <p class="text-sm font-semibold mb-2">Requesting Time Off</p>
            <p class="text-sm leading-relaxed">
              "Good morning, Sarah. I wanted to discuss something important with you. My brother is getting married in two months, and I need to take a week off to attend the wedding and help with the preparations. I know this is during our busy season, and I completely understand your concerns about the workload. However, this is a once-in-a-lifetime event for my family. I've been thinking about how we could manage this situation. What if I work extra hours in the weeks leading up to the wedding to get ahead on my projects? I could also train a colleague to handle my urgent tasks while I'm away. Would it be possible for us to discuss a solution that works for both the company and my family commitments?"
            </p>
          </div>
          <p class="text-xs text-blue-600 mb-4"><em>Read with professional tone. Emphasize key negotiation phrases and show appropriate emotion.</em></p>
          
          <button id="micButton3" class="microphone-button" onclick="toggleRecording(3)">
            <i class="fas fa-microphone"></i>
          </button>
          
          <div id="recordingStatus3" class="recording-status">
            Click the microphone to start recording
          </div>
          
          <div id="transcript3" class="transcript-display">
            Your speech will appear here as you speak...
          </div>
          
          <div id="feedback3" class="feedback-section" style="display: none;">
            <h4 class="font-semibold mb-2">📊 Analysis Results</h4>
            <div class="score-display">
              <div class="score-item">
                <div id="grammarScore3" class="score-value">--</div>
                <div class="score-label">Grammar</div>
              </div>
              <div class="score-item">
                <div id="pronunciationScore3" class="score-value">--</div>
                <div class="score-label">Pronunciation</div>
              </div>
              <div class="score-item">
                <div id="fluencyScore3" class="score-value">--</div>
                <div class="score-label">Fluency</div>
              </div>
              <div class="score-item">
                <div id="coherenceScore3" class="score-value">--</div>
                <div class="score-label">Coherence</div>
              </div>
            </div>
            <div id="detailedFeedback3" class="mt-3 text-sm">
              <!-- Detailed feedback will appear here -->
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <section
      class="card rounded-xl mt-6"
      aria-label="Speaking Task 4"
      id="task4Card"
    >
      <div class="inner-card">
        <div class="speaking-interface">
          <p class="text-sm font-semibold mb-2">🎤 Speaking Task 4 - Read Aloud</p>
          <p class="text-sm mb-4"><strong>Instructions:</strong> Read the following rent negotiation dialogue. Use different voices for the tenant and landlord.</p>
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-left">
            <p class="text-sm font-semibold mb-2">Rent Increase Negotiation</p>
            <p class="text-sm leading-relaxed mb-2">
              <strong>Tenant:</strong> "Hello, Mr. Johnson. Thank you for meeting with me today. I received your letter about the rent increase, and I wanted to discuss it with you. I understand that costs are rising everywhere, but a two-hundred-dollar increase seems quite substantial."
            </p>
            <p class="text-sm leading-relaxed mb-2">
              <strong>Landlord:</strong> "I appreciate you coming to talk about this, Maria. The increase reflects the current market rates and the improvements I've made to the building."
            </p>
            <p class="text-sm leading-relaxed">
              <strong>Tenant:</strong> "I've been a reliable tenant for two years now, always paying on time and taking good care of the apartment. Given my track record, perhaps we could negotiate a smaller increase? Maybe one hundred dollars instead of two hundred? I'd really like to continue living here, and I hope we can find a solution that works for both of us."
            </p>
          </div>
          <p class="text-xs text-blue-600 mb-4"><em>Distinguish between tenant and landlord voices. Show the negotiation dynamics through your tone.</em></p>
          
          <button id="micButton4" class="microphone-button" onclick="toggleRecording(4)">
            <i class="fas fa-microphone"></i>
          </button>
          
          <div id="recordingStatus4" class="recording-status">
            Click the microphone to start recording
          </div>
          
          <div id="transcript4" class="transcript-display">
            Your speech will appear here as you speak...
          </div>
          
          <div id="feedback4" class="feedback-section" style="display: none;">
            <h4 class="font-semibold mb-2">📊 Analysis Results</h4>
            <div class="score-display">
              <div class="score-item">
                <div id="grammarScore4" class="score-value">--</div>
                <div class="score-label">Grammar</div>
              </div>
              <div class="score-item">
                <div id="pronunciationScore4" class="score-value">--</div>
                <div class="score-label">Pronunciation</div>
              </div>
              <div class="score-item">
                <div id="fluencyScore4" class="score-value">--</div>
                <div class="score-label">Fluency</div>
              </div>
              <div class="score-item">
                <div id="coherenceScore4" class="score-value">--</div>
                <div class="score-label">Coherence</div>
              </div>
            </div>
            <div id="detailedFeedback4" class="mt-3 text-sm">
              <!-- Detailed feedback will appear here -->
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  <div class="next-button-container">
    <a href="speaking-negotiating-3.html" class="btn-animate inline-block text-center" aria-label="Next negotiating tasks">
      Next
    </a>
  </div>
  <script>
    // Speech recognition and recording functionality
    let mediaRecorder = {};
    let audioChunks = {};
    let isRecording = {};
    let recognition = {};
    let recordingTimeout = {};
    let recordingStartTime = {};
    
    // Initialize speech recognition if available
    function initializeSpeechRecognition(taskId) {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition[taskId] = new SpeechRecognition();
        recognition[taskId].continuous = true;
        recognition[taskId].interimResults = true;
        recognition[taskId].lang = 'en-US';
        
        recognition[taskId].onresult = function(event) {
          let transcript = '';
          for (let i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
          }
          document.getElementById(`transcript${taskId}`).textContent = transcript;
        };
        
        recognition[taskId].onerror = function(event) {
          console.error('Speech recognition error:', event.error);
          document.getElementById(`recordingStatus${taskId}`).textContent = 'Speech recognition error. Please try again.';
        };
        
        recognition[taskId].onend = function() {
          if (isRecording[taskId]) {
            recognition[taskId].start();
          }
        };
      }
    }
    
    // Initialize speech recognition for both tasks
    initializeSpeechRecognition(3);
    initializeSpeechRecognition(4);
    
    async function toggleRecording(taskId) {
      const micButton = document.getElementById(`micButton${taskId}`);
      const recordingStatus = document.getElementById(`recordingStatus${taskId}`);
      const transcript = document.getElementById(`transcript${taskId}`);
      const feedback = document.getElementById(`feedback${taskId}`);
      
      if (!isRecording[taskId]) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          
          mediaRecorder[taskId] = new MediaRecorder(stream);
          audioChunks[taskId] = [];
          isRecording[taskId] = true;
          recordingStartTime[taskId] = Date.now();
          
          micButton.classList.add('recording');
          micButton.innerHTML = '<i class="fas fa-stop"></i>';
          recordingStatus.textContent = 'Recording... Click to stop';
          transcript.textContent = 'Listening...';
          feedback.style.display = 'none';
          
          if (recognition[taskId]) {
            recognition[taskId].start();
          }
          
          mediaRecorder[taskId].ondataavailable = function(event) {
            audioChunks[taskId].push(event.data);
          };
          
          mediaRecorder[taskId].onstop = function() {
            const audioBlob = new Blob(audioChunks[taskId], { type: 'audio/wav' });
            const recordingDuration = (Date.now() - recordingStartTime[taskId]) / 1000;
            processRecording(taskId, audioBlob, recordingDuration);
          };
          
          mediaRecorder[taskId].start();
          
          recordingTimeout[taskId] = setTimeout(() => {
            if (isRecording[taskId]) {
              toggleRecording(taskId);
            }
          }, 180000);
          
        } catch (error) {
          console.error('Error accessing microphone:', error);
          recordingStatus.textContent = 'Error accessing microphone. Please check permissions.';
        }
      } else {
        isRecording[taskId] = false;
        
        if (mediaRecorder[taskId] && mediaRecorder[taskId].state !== 'inactive') {
          mediaRecorder[taskId].stop();
        }
        
        if (recognition[taskId]) {
          recognition[taskId].stop();
        }
        
        if (recordingTimeout[taskId]) {
          clearTimeout(recordingTimeout[taskId]);
        }
        
        micButton.classList.remove('recording');
        micButton.classList.add('processing');
        micButton.innerHTML = '<i class="fas fa-cog"></i>';
        recordingStatus.textContent = 'Processing your speech...';
        
        const stream = mediaRecorder[taskId].stream;
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
      }
    }
    
    function processRecording(taskId, audioBlob, duration) {
      setTimeout(() => {
        const micButton = document.getElementById(`micButton${taskId}`);
        const recordingStatus = document.getElementById(`recordingStatus${taskId}`);
        const feedback = document.getElementById(`feedback${taskId}`);
        
        micButton.classList.remove('processing');
        micButton.innerHTML = '<i class="fas fa-microphone"></i>';
        recordingStatus.textContent = 'Recording complete. Click to record again.';
        
        const scores = generateEnhancedScores(duration, taskId);
        displayFeedback(taskId, scores, duration);
        
        feedback.style.display = 'block';
      }, 2000);
    }
    
    function generateEnhancedScores(duration, taskId) {
      let baseGrammar = Math.floor(Math.random() * 3) + 4;
      let basePronunciation = Math.floor(Math.random() * 3) + 4;
      let baseFluency = Math.floor(Math.random() * 3) + 4;
      let baseCoherence = Math.floor(Math.random() * 3) + 4;
      
      // For read-aloud tasks, focus more on pronunciation and fluency
      if (duration < 30) {
        const penalty = Math.floor((30 - duration) / 5);
        baseFluency = Math.max(1, baseFluency - penalty);
        baseCoherence = Math.max(1, baseCoherence - penalty);
      }
      
      if (duration > 60) {
        basePronunciation = Math.min(9, basePronunciation + 1);
        baseFluency = Math.min(9, baseFluency + 1);
      }
      
      return {
        grammar: baseGrammar,
        pronunciation: basePronunciation,
        fluency: baseFluency,
        coherence: baseCoherence,
        duration: duration
      };
    }
    
    function displayFeedback(taskId, scores, duration) {
      document.getElementById(`grammarScore${taskId}`).textContent = scores.grammar + '/9';
      document.getElementById(`pronunciationScore${taskId}`).textContent = scores.pronunciation + '/9';
      document.getElementById(`fluencyScore${taskId}`).textContent = scores.fluency + '/9';
      document.getElementById(`coherenceScore${taskId}`).textContent = scores.coherence + '/9';
      
      const feedbackText = generateDetailedFeedback(scores, duration);
      document.getElementById(`detailedFeedback${taskId}`).innerHTML = feedbackText;
    }
    
    function generateDetailedFeedback(scores, duration) {
      let feedback = '<strong>Read-Aloud Analysis:</strong><br>';
      
      if (duration < 30) {
        feedback += `⚠️ <strong>Duration:</strong> Reading too fast (${Math.round(duration)}s). Take time to articulate clearly.<br>`;
      } else if (duration > 90) {
        feedback += `⚠️ <strong>Duration:</strong> Reading too slowly (${Math.round(duration)}s). Work on fluency.<br>`;
      } else {
        feedback += `✅ <strong>Duration:</strong> Good reading pace (${Math.round(duration)}s).<br>`;
      }
      
      if (scores.pronunciation >= 5) {
        feedback += '✅ <strong>Pronunciation:</strong> Clear articulation of negotiation vocabulary.<br>';
      } else {
        feedback += '⚠️ <strong>Pronunciation:</strong> Work on word stress and intonation patterns.<br>';
      }
      
      if (scores.fluency >= 5) {
        feedback += '✅ <strong>Fluency:</strong> Smooth reading with natural rhythm.<br>';
      } else {
        feedback += '⚠️ <strong>Fluency:</strong> Practice reading aloud to improve flow.<br>';
      }
      
      if (scores.coherence >= 5) {
        feedback += '✅ <strong>Expression:</strong> Good use of tone to convey meaning.';
      } else {
        feedback += '⚠️ <strong>Expression:</strong> Work on varying tone to show different speakers.';
      }
      
      return feedback;
    }

    // 3D card tilt effect
    const cards = document.querySelectorAll(".card");
    cards.forEach((card) => {
      card.addEventListener("mousemove", (e) => {
        const rect = card.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;
        const rotateX = ((y - centerY) / centerY) * 10;
        const rotateY = ((x - centerX) / centerX) * 10;
        card.style.transform = `rotateX(${-rotateX}deg) rotateY(${rotateY}deg) scale(1.05)`;
      });
      card.addEventListener("mouseleave", () => {
        card.style.transform = "rotateX(0deg) rotateY(0deg) scale(1)";
      });
    });
  </script>
</body>
</html>
